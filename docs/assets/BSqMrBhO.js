import{_ as Y}from"./CbB955xI.js";import{b as j,a as ee,r as D,E as c,F as u,G as o,O as b,M as F,P as E,H as d,K as Q,Q as N,I as se,J as te,R as T,S as $,T as I,U as V,V as ae,W as ne,X as oe,Y as le,Z as H,_ as re}from"./CN4NIEBA.js";const ie={class:"dev-panel"},ce={class:"auth-status"},ue={class:"status-ok"},de={class:"user-id"},_e={key:1,class:"status-error"},pe={key:0,class:"upload-section"},fe={class:"upload-buttons"},me={class:"upload-btn"},he={class:"upload-btn"},ge={key:0,class:"selected-files"},ve={key:0},be={class:"action-buttons"},ye=["disabled"],ke={key:1,class:"upload-results"},Re={class:"result-file"},Ce={key:0,class:"result-reason"},we={key:1,class:"result-error"},Se={key:2,class:"result-meta"},Ae={class:"back-link"},Ue=4e5,Fe=j({__name:"dev-upload",setup($e){const{currentUser:w,isAuthenticated:L}=ee(),y=D([]),x=D(!1),_=D([]);async function G(a){const e=new TextEncoder().encode(a),t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(i=>i.toString(16).padStart(2,"0")).join("")}function M(a,e){return`${a}_${e}`.replace(/[^a-zA-Z0-9]/g,"_").substring(0,100)}function P(a,e){const t=[];for(let s=0;s<a.length;s+=e)t.push(a.slice(s,s+e));return t}function W(a){const e=a.session_info||{},t=a.stints||[],s={track:e.track||a.track||"Unknown",date_start:e.date_start||a.date||new Date().toISOString(),date_end:e.date_end||null,car:e.car||a.car||null,session_type:e.session_type??null,driver:e.driver||null},i=["Flood","Wet","Damp","Greasy","Green","Fast","Optimum"],n={};i.forEach(p=>{n[p]={bestQualy:null,bestQualyTemp:null,bestRace:null,bestRaceTemp:null,bestAvgRace:null,bestAvgRaceTemp:null}});let g=null,m=null,h=null,k=null,v=null,R=null;t.forEach(p=>{const A=p.type==="Qualify",f=p.laps||[];if(f.forEach(l=>{if(l.is_valid&&!l.has_pit_stop&&l.lap_time_ms){const r=l.track_grip_status||"Unknown",C=l.air_temp||0,U={airTemp:C,roadTemp:l.road_temp||0,grip:r};n[r]&&(A?(!n[r].bestQualy||l.lap_time_ms<n[r].bestQualy)&&(n[r].bestQualy=l.lap_time_ms,n[r].bestQualyTemp=C):(!n[r].bestRace||l.lap_time_ms<n[r].bestRace)&&(n[r].bestRace=l.lap_time_ms,n[r].bestRaceTemp=C)),A?(!g||l.lap_time_ms<g)&&(g=l.lap_time_ms,m=U):(!h||l.lap_time_ms<h)&&(h=l.lap_time_ms,k=U)}}),!A&&p.avg_clean_lap&&f.length>=5){const l=f.find(U=>U.is_valid&&!U.has_pit_stop),r=l?.track_grip_status||f[0]?.track_grip_status||"Unknown",C=l?.air_temp||f[0]?.air_temp||0;n[r]&&(!n[r].bestAvgRace||p.avg_clean_lap<n[r].bestAvgRace)&&(n[r].bestAvgRace=p.avg_clean_lap,n[r].bestAvgRaceTemp=C),(!v||p.avg_clean_lap<v)&&(v=p.avg_clean_lap,R={airTemp:C,roadTemp:l?.road_temp||0,grip:r})}});const S={laps:e.laps_total||a.laps?.length||0,lapsValid:e.laps_valid||0,bestLap:e.session_best_lap||a.bestLap||null,avgCleanLap:e.avg_clean_lap||null,totalTime:e.total_drive_time_ms||0,stintCount:t.length||0,best_qualy_ms:g,best_qualy_conditions:m,best_race_ms:h,best_race_conditions:k,best_avg_race_ms:v,best_avg_race_conditions:R,best_by_grip:n};return{meta:s,summary:S}}async function z(a,e){try{const t=ae($,`users/${a}/sessions/${e}/rawChunks`),i=(await ne(t)).docs.map(n=>oe(n.ref));await Promise.all(i)}catch(t){console.warn("[UPLOAD] Error deleting old chunks:",t.message)}}async function J(a,e){const t=T($,`users/${a}/sessions/${e}`),s=await le(t);return s.exists()?{id:e,...s.data()}:null}async function K(a,e,t,s){try{const i=a.ownerId||null;if(i&&i!==s)return{status:"skipped",fileName:t,reason:`Owner mismatch (file: ${i.substring(0,8)}..., you: ${s.substring(0,8)}...)`};const{meta:n,summary:g}=W(a),m=M(n.date_start,n.track),h=await G(e),k=await J(s,m);let v=!1,R=!0;k&&(v=!0,k.fileHash===h?R=!1:await z(s,m));const S=P(e,Ue),p=T($,`users/${s}/sessions/${m}`);await I(p,{fileHash:h,fileName:t,uploadedAt:V(),meta:n,summary:g,rawChunkCount:S.length,rawSizeBytes:e.length,rawEncoding:"json-string",version:(k?.version||0)+1});const A=T($,`users/${s}/uploads/${h}`);if(await I(A,{fileName:t,uploadedAt:V(),sessionId:m}),R)for(let f=0;f<S.length;f++){const l=T($,`users/${s}/sessions/${m}/rawChunks/${f}`);await I(l,{idx:f,chunk:S[f]})}return{status:v?R?"updated":"refreshed":"created",fileName:t,sessionId:m,meta:n,summary:g}}catch(i){return{status:"error",fileName:t,error:i.message}}}function O(a){const e=a.target;e.files&&(_.value=Array.from(e.files).filter(t=>t.name.endsWith(".json")))}function Z(a){const e=a.target;e.files&&(_.value=Array.from(e.files).filter(t=>t.name.endsWith(".json")))}async function q(){if(!w.value||_.value.length===0)return;x.value=!0,y.value=[];const a=w.value.uid;for(const e of _.value)try{const t=await e.text(),s=JSON.parse(t),i=await K(s,t,e.name,a);y.value.push(i)}catch(t){y.value.push({status:"error",fileName:e.name,error:t.message})}x.value=!1,_.value=[]}function X(){y.value=[],_.value=[]}function B(a){switch(a){case"created":return"#4ade80";case"updated":return"#60a5fa";case"refreshed":return"#22d3ee";case"unchanged":return"#a1a1aa";case"skipped":return"#fbbf24";case"error":return"#f87171";default:return"#fff"}}return(a,e)=>{const t=Y;return u(),c("div",ie,[e[5]||(e[5]=o("header",{class:"dev-header"},[o("h1",null,"üõ†Ô∏è DEV Upload Panel"),o("p",null,"Upload JSON telemetry files to Firebase")],-1)),o("div",ce,[F(L)&&F(w)?(u(),c(E,{key:0},[o("span",ue,"‚úÖ Logged in as: "+d(F(w).email),1),o("span",de,"UID: "+d(F(w).uid),1)],64)):(u(),c("span",_e,"‚ùå Not logged in. Go to main app to login first."))]),F(L)?(u(),c("div",pe,[e[3]||(e[3]=o("h2",null,"Upload Files",-1)),o("div",fe,[o("label",me,[e[0]||(e[0]=Q(" üìÑ Select File(s) ",-1)),o("input",{type:"file",accept:".json",multiple:"",onChange:O,hidden:""},null,32)]),o("label",he,[e[1]||(e[1]=Q(" üìÅ Select Folder ",-1)),o("input",{type:"file",accept:".json",webkitdirectory:"",onChange:Z,hidden:""},null,32)])]),_.value.length>0?(u(),c("div",ge,[o("h3",null,"Selected: "+d(_.value.length)+" file(s)",1),o("ul",null,[(u(!0),c(E,null,N(_.value.slice(0,10),s=>(u(),c("li",{key:s.name},d(s.name)+" ("+d((s.size/1024).toFixed(1))+" KB) ",1))),128)),_.value.length>10?(u(),c("li",ve,"... and "+d(_.value.length-10)+" more",1)):b("",!0)]),o("div",be,[o("button",{class:"btn-upload",disabled:x.value,onClick:q},d(x.value?"Uploading...":"üöÄ Upload to Firebase"),9,ye),o("button",{class:"btn-clear",onClick:X},"Clear")])])):b("",!0),y.value.length>0?(u(),c("div",ke,[e[2]||(e[2]=o("h3",null,"Results",-1)),(u(!0),c(E,null,N(y.value,(s,i)=>(u(),c("div",{key:i,class:"result-item",style:H({borderLeftColor:B(s.status)})},[o("span",{class:"result-status",style:H({color:B(s.status)})},d(s.status.toUpperCase()),5),o("span",Re,d(s.fileName),1),s.reason?(u(),c("span",Ce,d(s.reason),1)):b("",!0),s.error?(u(),c("span",we,d(s.error),1)):b("",!0),s.meta?(u(),c("span",Se,d(s.meta.track)+" | "+d(s.meta.car),1)):b("",!0)],4))),128))])):b("",!0)])):b("",!0),o("div",Ae,[se(t,{to:"/panoramica"},{default:te(()=>[...e[4]||(e[4]=[Q("‚Üê Back to Dashboard",-1)])]),_:1})])])}}}),De=re(Fe,[["__scopeId","data-v-f68331be"]]);export{De as default};
