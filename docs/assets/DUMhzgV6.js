import{_ as Y}from"./DbnrVhsG.js";import{b as j,a as ee,r as D,C as c,D as u,E as o,N as b,K as x,O as E,F as d,I as Q,P as B,G as se,H as te,Q as T,R as F,S as I,T as V,U as ae,V as ne,W as oe,X as le,Y as H,_ as re}from"./B6zfpVci.js";const ie={class:"dev-panel"},ce={class:"auth-status"},ue={class:"status-ok"},de={class:"user-id"},_e={key:1,class:"status-error"},pe={key:0,class:"upload-section"},me={class:"upload-buttons"},fe={class:"upload-btn"},he={class:"upload-btn"},ge={key:0,class:"selected-files"},ve={key:0},be={class:"action-buttons"},ye=["disabled"],ke={key:1,class:"upload-results"},Ce={class:"result-file"},Re={key:0,class:"result-reason"},we={key:1,class:"result-error"},Ae={key:2,class:"result-meta"},Se={class:"back-link"},Ue=4e5,xe=j({__name:"dev-upload",setup(Fe){const{currentUser:w,isAuthenticated:L}=ee(),y=D([]),$=D(!1),_=D([]);async function P(a){const e=new TextEncoder().encode(a),t=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(t)).map(i=>i.toString(16).padStart(2,"0")).join("")}function G(a,e){return`${a}_${e}`.replace(/[^a-zA-Z0-9]/g,"_").substring(0,100)}function M(a,e){const t=[];for(let s=0;s<a.length;s+=e)t.push(a.slice(s,s+e));return t}function O(a){const e=a.session_info||{},t=a.stints||[],s={track:e.track||a.track||"Unknown",date_start:e.date_start||a.date||new Date().toISOString(),date_end:e.date_end||null,car:e.car||a.car||null,session_type:e.session_type??null,driver:e.driver||null},i=["Flood","Wet","Damp","Greasy","Green","Fast","Optimum"],n={};i.forEach(p=>{n[p]={bestQualy:null,bestQualyTemp:null,bestRace:null,bestRaceTemp:null,bestAvgRace:null,bestAvgRaceTemp:null}});let g=null,f=null,h=null,k=null,v=null,C=null;t.forEach(p=>{const S=p.type==="Qualify",m=p.laps||[];if(m.forEach(l=>{if(l.is_valid&&!l.has_pit_stop&&l.lap_time_ms){const r=l.track_grip_status||"Unknown",R=l.air_temp||0,U={airTemp:R,roadTemp:l.road_temp||0,grip:r};n[r]&&(S?(!n[r].bestQualy||l.lap_time_ms<n[r].bestQualy)&&(n[r].bestQualy=l.lap_time_ms,n[r].bestQualyTemp=R):(!n[r].bestRace||l.lap_time_ms<n[r].bestRace)&&(n[r].bestRace=l.lap_time_ms,n[r].bestRaceTemp=R)),S?(!g||l.lap_time_ms<g)&&(g=l.lap_time_ms,f=U):(!h||l.lap_time_ms<h)&&(h=l.lap_time_ms,k=U)}}),!S&&p.avg_clean_lap&&m.length>=5){const l=m.find(U=>U.is_valid&&!U.has_pit_stop),r=l?.track_grip_status||m[0]?.track_grip_status||"Unknown",R=l?.air_temp||m[0]?.air_temp||0;n[r]&&(!n[r].bestAvgRace||p.avg_clean_lap<n[r].bestAvgRace)&&(n[r].bestAvgRace=p.avg_clean_lap,n[r].bestAvgRaceTemp=R),(!v||p.avg_clean_lap<v)&&(v=p.avg_clean_lap,C={airTemp:R,roadTemp:l?.road_temp||0,grip:r})}});const A={laps:e.laps_total||a.laps?.length||0,lapsValid:e.laps_valid||0,bestLap:e.session_best_lap||a.bestLap||null,avgCleanLap:e.avg_clean_lap||null,totalTime:e.total_drive_time_ms||0,stintCount:t.length||0,best_qualy_ms:g,best_qualy_conditions:f,best_race_ms:h,best_race_conditions:k,best_avg_race_ms:v,best_avg_race_conditions:C,best_by_grip:n};return console.log("[UPLOAD] Extracted summary:",{track:s.track,stintCount:t.length,best_qualy_ms:g,best_race_ms:h}),{meta:s,summary:A}}async function W(a,e){try{const t=ae(F,`users/${a}/sessions/${e}/rawChunks`),i=(await ne(t)).docs.map(n=>oe(n.ref));await Promise.all(i)}catch(t){console.warn("[UPLOAD] Error deleting old chunks:",t.message)}}async function q(a,e){const t=T(F,`users/${a}/sessions/${e}`),s=await le(t);return s.exists()?{id:e,...s.data()}:null}async function z(a,e,t,s){try{const i=a.ownerId||null;if(i&&i!==s)return{status:"skipped",fileName:t,reason:`Owner mismatch (file: ${i.substring(0,8)}..., you: ${s.substring(0,8)}...)`};const{meta:n,summary:g}=O(a),f=G(n.date_start,n.track),h=await P(e),k=await q(s,f);let v=!1,C=!0;k&&(v=!0,k.fileHash===h?C=!1:await W(s,f));const A=M(e,Ue),p=T(F,`users/${s}/sessions/${f}`);await I(p,{fileHash:h,fileName:t,uploadedAt:V(),meta:n,summary:g,rawChunkCount:A.length,rawSizeBytes:e.length,rawEncoding:"json-string",version:(k?.version||0)+1});const S=T(F,`users/${s}/uploads/${h}`);if(await I(S,{fileName:t,uploadedAt:V(),sessionId:f}),C)for(let m=0;m<A.length;m++){const l=T(F,`users/${s}/sessions/${f}/rawChunks/${m}`);await I(l,{idx:m,chunk:A[m]})}return{status:v?C?"updated":"refreshed":"created",fileName:t,sessionId:f,meta:n,summary:g}}catch(i){return{status:"error",fileName:t,error:i.message}}}function K(a){const e=a.target;e.files&&(_.value=Array.from(e.files).filter(t=>t.name.endsWith(".json")))}function J(a){const e=a.target;e.files&&(_.value=Array.from(e.files).filter(t=>t.name.endsWith(".json")))}async function Z(){if(!w.value||_.value.length===0)return;$.value=!0,y.value=[];const a=w.value.uid;for(const e of _.value)try{const t=await e.text(),s=JSON.parse(t),i=await z(s,t,e.name,a);y.value.push(i)}catch(t){y.value.push({status:"error",fileName:e.name,error:t.message})}$.value=!1,_.value=[]}function X(){y.value=[],_.value=[]}function N(a){switch(a){case"created":return"#4ade80";case"updated":return"#60a5fa";case"refreshed":return"#22d3ee";case"unchanged":return"#a1a1aa";case"skipped":return"#fbbf24";case"error":return"#f87171";default:return"#fff"}}return(a,e)=>{const t=Y;return u(),c("div",ie,[e[5]||(e[5]=o("header",{class:"dev-header"},[o("h1",null,"üõ†Ô∏è DEV Upload Panel"),o("p",null,"Upload JSON telemetry files to Firebase")],-1)),o("div",ce,[x(L)&&x(w)?(u(),c(E,{key:0},[o("span",ue,"‚úÖ Logged in as: "+d(x(w).email),1),o("span",de,"UID: "+d(x(w).uid),1)],64)):(u(),c("span",_e,"‚ùå Not logged in. Go to main app to login first."))]),x(L)?(u(),c("div",pe,[e[3]||(e[3]=o("h2",null,"Upload Files",-1)),o("div",me,[o("label",fe,[e[0]||(e[0]=Q(" üìÑ Select File(s) ",-1)),o("input",{type:"file",accept:".json",multiple:"",onChange:K,hidden:""},null,32)]),o("label",he,[e[1]||(e[1]=Q(" üìÅ Select Folder ",-1)),o("input",{type:"file",accept:".json",webkitdirectory:"",onChange:J,hidden:""},null,32)])]),_.value.length>0?(u(),c("div",ge,[o("h3",null,"Selected: "+d(_.value.length)+" file(s)",1),o("ul",null,[(u(!0),c(E,null,B(_.value.slice(0,10),s=>(u(),c("li",{key:s.name},d(s.name)+" ("+d((s.size/1024).toFixed(1))+" KB) ",1))),128)),_.value.length>10?(u(),c("li",ve,"... and "+d(_.value.length-10)+" more",1)):b("",!0)]),o("div",be,[o("button",{class:"btn-upload",disabled:$.value,onClick:Z},d($.value?"Uploading...":"üöÄ Upload to Firebase"),9,ye),o("button",{class:"btn-clear",onClick:X},"Clear")])])):b("",!0),y.value.length>0?(u(),c("div",ke,[e[2]||(e[2]=o("h3",null,"Results",-1)),(u(!0),c(E,null,B(y.value,(s,i)=>(u(),c("div",{key:i,class:"result-item",style:H({borderLeftColor:N(s.status)})},[o("span",{class:"result-status",style:H({color:N(s.status)})},d(s.status.toUpperCase()),5),o("span",Ce,d(s.fileName),1),s.reason?(u(),c("span",Re,d(s.reason),1)):b("",!0),s.error?(u(),c("span",we,d(s.error),1)):b("",!0),s.meta?(u(),c("span",Ae,d(s.meta.track)+" | "+d(s.meta.car),1)):b("",!0)],4))),128))])):b("",!0)])):b("",!0),o("div",Se,[se(t,{to:"/panoramica"},{default:te(()=>[...e[4]||(e[4]=[Q("‚Üê Back to Dashboard",-1)])]),_:1})])])}}}),De=re(xe,[["__scopeId","data-v-ddfb8e93"]]);export{De as default};
