import{_ as te}from"./IrcXy1tG.js";import{b as ae,a as ne,r as B,E as f,F as m,G as r,P as A,M as D,Q as I,H as b,K as E,R as G,I as le,J as oe,S as $,T as C,U as F,V as L,W as re,X as ce,Y as ie,Z as N,$ as H,_ as ue}from"./DRE7tGjo.js";const de={class:"dev-panel"},_e={class:"auth-status"},pe={class:"status-ok"},fe={class:"user-id"},me={key:1,class:"status-error"},be={key:0,class:"upload-section"},he={class:"upload-buttons"},ye={class:"upload-btn"},ve={class:"upload-btn"},ge={key:0,class:"selected-files"},ke={key:0},Re={class:"action-buttons"},Ae=["disabled"],we={key:1,class:"upload-results"},Se={class:"result-file"},Ce={key:0,class:"result-reason"},Ue={key:1,class:"result-error"},Qe={key:2,class:"result-meta"},Te={class:"back-link"},De=4e5,$e=ae({__name:"dev-upload",setup(xe){const{currentUser:U,isAuthenticated:P}=ne(),w=B([]),x=B(!1),v=B([]);async function W(t){const e=new TextEncoder().encode(t),a=await crypto.subtle.digest("SHA-256",e);return Array.from(new Uint8Array(a)).map(i=>i.toString(16).padStart(2,"0")).join("")}function M(t,e){return`${t}_${e}`.replace(/[^a-zA-Z0-9]/g,"_").substring(0,100)}function q(t,e){const a=[];for(let s=0;s<t.length;s+=e)a.push(t.slice(s,s+e));return a}function z(t){const e=t.session_info||{},a=t.stints||[],s={track:e.track||t.track||"Unknown",date_start:e.date_start||t.date||new Date().toISOString(),date_end:e.date_end||null,car:e.car||t.car||null,session_type:e.session_type??null,driver:e.driver||null},i=["Flood","Wet","Damp","Greasy","Green","Fast","Optimum"],l={};i.forEach(g=>{l[g]={bestQualy:null,bestQualyTemp:null,bestRace:null,bestRaceTemp:null,bestAvgRace:null,bestAvgRaceTemp:null}});let h=null,_=null,p=null,R=null,o=null,y=null;const n=e.session_type===1;a.forEach(g=>{const Q=n||g.type==="Qualify",k=g.laps||[];if(k.forEach(c=>{if(c.is_valid&&!c.has_pit_stop&&c.lap_time_ms){const d=c.track_grip_status||"Unknown",S=c.air_temp||0,T={airTemp:S,roadTemp:c.road_temp||0,grip:d};l[d]&&(Q?(!l[d].bestQualy||c.lap_time_ms<l[d].bestQualy)&&(l[d].bestQualy=c.lap_time_ms,l[d].bestQualyTemp=S):(!l[d].bestRace||c.lap_time_ms<l[d].bestRace)&&(l[d].bestRace=c.lap_time_ms,l[d].bestRaceTemp=S)),Q?(!h||c.lap_time_ms<h)&&(h=c.lap_time_ms,_=T):(!p||c.lap_time_ms<p)&&(p=c.lap_time_ms,R=T)}}),!Q&&g.avg_clean_lap&&k.length>=5){const c=k.find(T=>T.is_valid&&!T.has_pit_stop),d=c?.track_grip_status||k[0]?.track_grip_status||"Unknown",S=c?.air_temp||k[0]?.air_temp||0;l[d]&&(!l[d].bestAvgRace||g.avg_clean_lap<l[d].bestAvgRace)&&(l[d].bestAvgRace=g.avg_clean_lap,l[d].bestAvgRaceTemp=S),(!o||g.avg_clean_lap<o)&&(o=g.avg_clean_lap,y={airTemp:S,roadTemp:c?.road_temp||0,grip:d})}});const u={laps:e.laps_total||t.laps?.length||0,lapsValid:e.laps_valid||0,bestLap:e.session_best_lap||t.bestLap||null,avgCleanLap:e.avg_clean_lap||null,totalTime:e.total_drive_time_ms||0,stintCount:a.length||0,best_qualy_ms:h,best_qualy_conditions:_,best_race_ms:p,best_race_conditions:R,best_avg_race_ms:o,best_avg_race_conditions:y,best_by_grip:l};return console.log("[UPLOAD] Extracted summary:",{track:s.track,stintCount:a.length,best_qualy_ms:h,best_race_ms:p}),{meta:s,summary:u}}async function J(t,e){try{const a=re(C,`users/${t}/sessions/${e}/rawChunks`),i=(await ce(a)).docs.map(l=>ie(l.ref));await Promise.all(i)}catch(a){console.warn("[UPLOAD] Error deleting old chunks:",a.message)}}async function K(t,e){const a=$(C,`users/${t}/sessions/${e}`),s=await N(a);return s.exists()?{id:e,...s.data()}:null}async function Z(t,e,a,s,i){const l=e.toLowerCase().replace(/\s+/g,"_"),h=$(C,`users/${t}/trackBests/${l}`);try{const _=await N(h),p=_.exists()?_.data():null,R=["Flood","Wet","Damp","Greasy","Green","Fast","Optimum"],o=p?.bests||(p?Object.fromEntries(R.filter(n=>p[n]).map(n=>[n,p[n]])):{});let y=!1;return R.forEach(n=>{const u=i.best_by_grip?.[n];u&&(o[n]||(o[n]={bestQualy:null,bestQualyTemp:null,bestQualySessionId:null,bestQualyDate:null,bestRace:null,bestRaceTemp:null,bestRaceSessionId:null,bestRaceDate:null,bestAvgRace:null,bestAvgRaceTemp:null,bestAvgRaceSessionId:null,bestAvgRaceDate:null}),u.bestQualy&&(!o[n].bestQualy||u.bestQualy<o[n].bestQualy)&&(o[n].bestQualy=u.bestQualy,o[n].bestQualyTemp=u.bestQualyTemp,o[n].bestQualySessionId=a,o[n].bestQualyDate=s,y=!0),u.bestRace&&(!o[n].bestRace||u.bestRace<o[n].bestRace)&&(o[n].bestRace=u.bestRace,o[n].bestRaceTemp=u.bestRaceTemp,o[n].bestRaceSessionId=a,o[n].bestRaceDate=s,y=!0),u.bestAvgRace&&(!o[n].bestAvgRace||u.bestAvgRace<o[n].bestAvgRace)&&(o[n].bestAvgRace=u.bestAvgRace,o[n].bestAvgRaceTemp=u.bestAvgRaceTemp,o[n].bestAvgRaceSessionId=a,o[n].bestAvgRaceDate=s,y=!0))}),y?(await F(h,{trackId:l,bests:o,lastUpdated:L()}),console.log(`[UPLOAD] ‚úÖ Updated trackBests for ${l}`)):console.log(`[UPLOAD] ‚ÑπÔ∏è No improvements for ${l}, skipping trackBests update`),y}catch(_){return console.warn(`[UPLOAD] ‚ö†Ô∏è Error updating trackBests for ${l}:`,_.message),!1}}async function X(t,e,a,s){try{const i=t.ownerId||null;if(i&&i!==s)return{status:"skipped",fileName:a,reason:`Owner mismatch (file: ${i.substring(0,8)}..., you: ${s.substring(0,8)}...)`};const{meta:l,summary:h}=z(t),_=M(l.date_start,l.track),p=await W(e),R=await K(s,_);let o=!1,y=!0;R&&(o=!0,R.fileHash===p?y=!1:await J(s,_));const n=q(e,De),u=$(C,`users/${s}/sessions/${_}`);await F(u,{fileHash:p,fileName:a,uploadedAt:L(),meta:l,summary:h,rawChunkCount:n.length,rawSizeBytes:e.length,rawEncoding:"json-string",version:(R?.version||0)+1});const g=$(C,`users/${s}/uploads/${p}`);if(await F(g,{fileName:a,uploadedAt:L(),sessionId:_}),y)for(let k=0;k<n.length;k++){const c=$(C,`users/${s}/sessions/${_}/rawChunks/${k}`);await F(c,{idx:k,chunk:n[k]})}const Q=await Z(s,l.track,_,l.date_start,h);return{status:o?y?"updated":"refreshed":"created",fileName:a,sessionId:_,meta:l,summary:h,trackBestsUpdated:Q}}catch(i){return{status:"error",fileName:a,error:i.message}}}function V(t){return!(!t.endsWith(".json")||!t.startsWith("session_")||t.startsWith(".")||t.includes("upload_registry"))}function Y(t){const e=t.target;e.files&&(v.value=Array.from(e.files).filter(a=>V(a.name)))}function j(t){const e=t.target;e.files&&(v.value=Array.from(e.files).filter(a=>V(a.name)))}async function ee(){if(!U.value||v.value.length===0)return;x.value=!0,w.value=[];const t=U.value.uid;for(const e of v.value)try{const a=await e.text(),s=JSON.parse(a),i=await X(s,a,e.name,t);w.value.push(i)}catch(a){w.value.push({status:"error",fileName:e.name,error:a.message})}x.value=!1,v.value=[]}function se(){w.value=[],v.value=[]}function O(t){switch(t){case"created":return"#4ade80";case"updated":return"#60a5fa";case"refreshed":return"#22d3ee";case"unchanged":return"#a1a1aa";case"skipped":return"#fbbf24";case"error":return"#f87171";default:return"#fff"}}return(t,e)=>{const a=te;return m(),f("div",de,[e[5]||(e[5]=r("header",{class:"dev-header"},[r("h1",null,"üõ†Ô∏è DEV Upload Panel"),r("p",null,"Upload JSON telemetry files to Firebase")],-1)),r("div",_e,[D(P)&&D(U)?(m(),f(I,{key:0},[r("span",pe,"‚úÖ Logged in as: "+b(D(U).email),1),r("span",fe,"UID: "+b(D(U).uid),1)],64)):(m(),f("span",me,"‚ùå Not logged in. Go to main app to login first."))]),D(P)?(m(),f("div",be,[e[3]||(e[3]=r("h2",null,"Upload Files",-1)),r("div",he,[r("label",ye,[e[0]||(e[0]=E(" üìÑ Select File(s) ",-1)),r("input",{type:"file",accept:".json",multiple:"",onChange:Y,hidden:""},null,32)]),r("label",ve,[e[1]||(e[1]=E(" üìÅ Select Folder ",-1)),r("input",{type:"file",accept:".json",webkitdirectory:"",onChange:j,hidden:""},null,32)])]),v.value.length>0?(m(),f("div",ge,[r("h3",null,"Selected: "+b(v.value.length)+" file(s)",1),r("ul",null,[(m(!0),f(I,null,G(v.value.slice(0,10),s=>(m(),f("li",{key:s.name},b(s.name)+" ("+b((s.size/1024).toFixed(1))+" KB) ",1))),128)),v.value.length>10?(m(),f("li",ke,"... and "+b(v.value.length-10)+" more",1)):A("",!0)]),r("div",Re,[r("button",{class:"btn-upload",disabled:x.value,onClick:ee},b(x.value?"Uploading...":"üöÄ Upload to Firebase"),9,Ae),r("button",{class:"btn-clear",onClick:se},"Clear")])])):A("",!0),w.value.length>0?(m(),f("div",we,[e[2]||(e[2]=r("h3",null,"Results",-1)),(m(!0),f(I,null,G(w.value,(s,i)=>(m(),f("div",{key:i,class:"result-item",style:H({borderLeftColor:O(s.status)})},[r("span",{class:"result-status",style:H({color:O(s.status)})},b(s.status.toUpperCase()),5),r("span",Se,b(s.fileName),1),s.reason?(m(),f("span",Ce,b(s.reason),1)):A("",!0),s.error?(m(),f("span",Ue,b(s.error),1)):A("",!0),s.meta?(m(),f("span",Qe,b(s.meta.track)+" | "+b(s.meta.car),1)):A("",!0)],4))),128))])):A("",!0)])):A("",!0),r("div",Te,[le(a,{to:"/panoramica"},{default:oe(()=>[...e[4]||(e[4]=[E("‚Üê Back to Dashboard",-1)])]),_:1})])])}}}),Ie=ue($e,[["__scopeId","data-v-236bc2cd"]]);export{Ie as default};
