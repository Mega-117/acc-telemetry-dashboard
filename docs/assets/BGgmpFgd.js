import{b as O,C as U,D as B,a6 as F,_ as q,r as v,a as N,m as _,P as Y,Q as A,W as x,T as E,a2 as S,ac as k,U as T}from"./CTuHB7ni.js";const P={class:"page-container"},j=O({__name:"PageContainer",setup(s){return(n,b)=>(B(),U("div",P,[F(n.$slots,"default",{},void 0)]))}}),W=Object.assign(q(j,[["__scopeId","data-v-71e40101"]]),{__name:"LayoutPageContainer"}),y={RACE:0,QUALIFY:1,PRACTICE:2};function z(s){switch(s){case 0:return"race";case 1:return"qualify";default:return"practice"}}function V(s){if(!s||s<=0)return"--:--.---";const n=Math.round(s),b=Math.floor(n/6e4),R=Math.floor(n%6e4/1e3),h=n%1e3;return`${b}:${R.toString().padStart(2,"0")}.${h.toString().padStart(3,"0")}`}function J(s){return s?s.split("_").map((n,b)=>n.match(/^gt\d$/i)||n.length<=2?n.toUpperCase():n.charAt(0).toUpperCase()+n.slice(1).toLowerCase()).join(" "):"Unknown"}function Z(s){return s?s.split("_").map(n=>n.charAt(0).toUpperCase()+n.slice(1).toLowerCase()).join(" "):"Unknown"}function K(s){if(!s)return"-";const n=new Date(s);return`${n.getDate()} ${["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"][n.getMonth()]} ${n.getFullYear()}`}function X(s){if(!s)return"-";const n=new Date(s);return`${n.getDate()} ${["GENNAIO","FEBBRAIO","MARZO","APRILE","MAGGIO","GIUGNO","LUGLIO","AGOSTO","SETTEMBRE","OTTOBRE","NOVEMBRE","DICEMBRE"][n.getMonth()]} ${n.getFullYear()}`}function ee(s){if(!s)return"-";const n=new Date(s);return`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`}function te(){const s=v([]),n=v(!1),b=v(null),{currentUser:R}=N();async function h(u){const t=u||R.value?.uid;if(!t)return console.warn("[TELEMETRY] No user ID provided"),[];n.value=!0,b.value=null;try{const o=E(A,`users/${t}/sessions`);let e;try{const a=S(o,k("uploadedAt","desc"));e=await T(a)}catch{console.warn("[TELEMETRY] orderBy failed, fetching without order"),e=await T(o)}return s.value=e.docs.map(a=>{const c=a.data();return{sessionId:a.id,fileHash:c.fileHash||null,fileName:c.fileName||null,uploadedAt:c.uploadedAt||null,meta:c.meta||{},summary:c.summary||{},rawChunkCount:c.rawChunkCount||0,rawSizeBytes:c.rawSizeBytes||0}}),s.value.sort((a,c)=>(c.meta.date_start||"").localeCompare(a.meta.date_start||"")),console.log(`[TELEMETRY] Loaded ${s.value.length} sessions for user ${t}`),s.value}catch(o){return console.error("[TELEMETRY] Error loading sessions:",o),b.value=o.message,[]}finally{n.value=!1}}async function M(u,t){const o=t||R.value?.uid;if(!o)return null;try{const e=Y(A,`users/${o}/sessions/${u}`),a=await x(e);if(!a.exists()||(a.data().rawChunkCount||0)===0)return null;const m=E(A,`users/${o}/sessions/${u}/rawChunks`),l=S(m,k("idx","asc")),f=await T(l),r=[];f.forEach(g=>{const p=g.data();r.push({idx:p.idx,chunk:p.chunk})}),r.sort((g,p)=>g.idx-p.idx);const i=r.map(g=>g.chunk).join("");return JSON.parse(i)}catch(e){return console.error("[TELEMETRY] Error fetching full session:",e),null}}const C=_(()=>s.value.length===0?null:s.value[0]),L=_(()=>C.value?.meta.car||null),w=_(()=>C.value?.meta.track||null),D=_(()=>{const u=["Flood","Wet","Damp","Greasy","Green","Fast","Optimum"],t={};for(const o of s.value){const e=(o.meta.track||"unknown").toLowerCase(),a=o.summary;if(!t[e]){const f={};u.forEach(r=>{f[r]={bestQualy:null,bestQualyTemp:null,bestRace:null,bestRaceTemp:null,bestAvgRace:null,bestAvgRaceTemp:null}}),t[e]={track:o.meta.track,sessions:0,lastSession:o.meta.date_start,bestQualy:null,bestQualyConditions:null,bestRace:null,bestRaceConditions:null,bestAvgRace:null,bestAvgRaceConditions:null,bestByGrip:f}}t[e].sessions++,o.meta.date_start>t[e].lastSession&&(t[e].lastSession=o.meta.date_start);const c=a?.best_by_grip;if(c)for(const f of u){const r=c[f];if(!r)continue;const i=t[e].bestByGrip[f];r.bestQualy&&(!i.bestQualy||r.bestQualy<i.bestQualy)&&(i.bestQualy=r.bestQualy,i.bestQualyTemp=r.bestQualyTemp),r.bestRace&&(!i.bestRace||r.bestRace<i.bestRace)&&(i.bestRace=r.bestRace,i.bestRaceTemp=r.bestRaceTemp),r.bestAvgRace&&(!i.bestAvgRace||r.bestAvgRace<i.bestAvgRace)&&(i.bestAvgRace=r.bestAvgRace,i.bestAvgRaceTemp=r.bestAvgRaceTemp)}const d=a?.best_qualy_ms;d?(!t[e].bestQualy||d<t[e].bestQualy)&&(t[e].bestQualy=d,t[e].bestQualyConditions=a.best_qualy_conditions||null):o.meta.session_type===y.QUALIFY&&a?.bestLap&&(!t[e].bestQualy||a.bestLap<t[e].bestQualy)&&(t[e].bestQualy=a.bestLap,t[e].bestQualyConditions=null);const m=a?.best_race_ms;m?(!t[e].bestRace||m<t[e].bestRace)&&(t[e].bestRace=m,t[e].bestRaceConditions=a.best_race_conditions||null):o.meta.session_type===y.RACE&&a?.bestLap&&(!t[e].bestRace||a.bestLap<t[e].bestRace)&&(t[e].bestRace=a.bestLap,t[e].bestRaceConditions=null);const l=a?.best_avg_race_ms;l&&(!t[e].bestAvgRace||l<t[e].bestAvgRace)&&(t[e].bestAvgRace=l,t[e].bestAvgRaceConditions=a.best_avg_race_conditions||null)}return Object.values(t).sort((o,e)=>(e.lastSession||"").localeCompare(o.lastSession||""))});function Q(u){return s.value.filter(t=>(t.meta.track||"").toLowerCase()===u.toLowerCase())}function I(u){return s.value.find(t=>t.sessionId===u)}function $(u=7){const t=new Date,o=["Dom","Lun","Mar","Mer","Gio","Ven","Sab"],e=[];for(let a=u-1;a>=0;a--){const c=new Date(t.getTime()-a*24*60*60*1e3),d=c.toISOString().split("T")[0],m=s.value.filter(i=>i.meta.date_start?.startsWith(d));let l=0,f=0,r=0;for(const i of m){const g=i.summary?.totalTime||0,p=Math.round(g/6e4);switch(i.meta.session_type){case y.PRACTICE:l+=p;break;case y.QUALIFY:f+=p;break;case y.RACE:r+=p;break}}e.push({day:o[c.getDay()],practice:l,qualify:f,race:r})}return e}const G=_(()=>{const u=new Date,t=new Date(u.getTime()-10080*60*1e3);let o=0,e=0,a=0,c=0,d=0,m=0;for(const l of s.value){if(new Date(l.meta.date_start)<t)continue;const r=l.summary?.totalTime||0,i=Math.round(r/6e4);switch(l.meta.session_type){case y.PRACTICE:o+=i,e++;break;case y.QUALIFY:a+=i,c++;break;case y.RACE:d+=i,m++;break}}return{practice:{minutes:o,sessions:e},qualify:{minutes:a,sessions:c},race:{minutes:d,sessions:m}}});return{sessions:s,isLoading:n,error:b,loadSessions:h,fetchSessionFull:M,getSessionsForTrack:Q,getSession:I,getActivityData:$,lastSession:C,lastUsedCar:L,lastUsedTrack:w,trackStats:D,activityTotals:G}}export{y as S,W as _,J as a,Z as b,ee as c,X as d,K as e,V as f,z as g,te as u};
