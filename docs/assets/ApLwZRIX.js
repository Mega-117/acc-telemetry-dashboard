import{b as O,C as U,D as B,a6 as F,_ as N,r as C,a as q,m as g,P as Y,Q as A,W as x,T as S,a2 as L,ac as k,U as E}from"./D0g2xLIp.js";const P={class:"page-container"},j=O({__name:"PageContainer",setup(a){return(n,f)=>(B(),U("div",P,[F(n.$slots,"default",{},void 0)]))}}),W=Object.assign(N(j,[["__scopeId","data-v-71e40101"]]),{__name:"LayoutPageContainer"}),R={RACE:0,QUALIFY:1,PRACTICE:2};function z(a){switch(a){case 0:return"race";case 1:return"qualify";default:return"practice"}}function V(a){if(!a||a<=0)return"--:--.---";const n=Math.round(a),f=Math.floor(n/6e4),m=Math.floor(n%6e4/1e3),h=n%1e3;return`${f}:${m.toString().padStart(2,"0")}.${h.toString().padStart(3,"0")}`}function J(a){return a?a.split("_").map((n,f)=>n.match(/^gt\d$/i)||n.length<=2?n.toUpperCase():n.charAt(0).toUpperCase()+n.slice(1).toLowerCase()).join(" "):"Unknown"}function Z(a){return a?a.split("_").map(n=>n.charAt(0).toUpperCase()+n.slice(1).toLowerCase()).join(" "):"Unknown"}function K(a){if(!a)return"-";const n=new Date(a);return`${n.getDate()} ${["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"][n.getMonth()]} ${n.getFullYear()}`}function X(a){if(!a)return"-";const n=new Date(a);return`${n.getDate()} ${["GENNAIO","FEBBRAIO","MARZO","APRILE","MAGGIO","GIUGNO","LUGLIO","AGOSTO","SETTEMBRE","OTTOBRE","NOVEMBRE","DICEMBRE"][n.getMonth()]} ${n.getFullYear()}`}function ee(a){if(!a)return"-";const n=new Date(a);return`${n.getHours().toString().padStart(2,"0")}:${n.getMinutes().toString().padStart(2,"0")}`}function te(){const a=C([]),n=C(!1),f=C(null),{currentUser:m}=q();async function h(r){const e=r||m.value?.uid;if(!e)return console.warn("[TELEMETRY] No user ID provided"),[];n.value=!0,f.value=null;try{const s=S(A,`users/${e}/sessions`);let t;try{const o=L(s,k("uploadedAt","desc"));t=await E(o)}catch{console.warn("[TELEMETRY] orderBy failed, fetching without order"),t=await E(s)}return a.value=t.docs.map(o=>{const i=o.data();return{sessionId:o.id,fileHash:i.fileHash||null,fileName:i.fileName||null,uploadedAt:i.uploadedAt||null,meta:i.meta||{},summary:i.summary||{},rawChunkCount:i.rawChunkCount||0,rawSizeBytes:i.rawSizeBytes||0}}),a.value.sort((o,i)=>(i.meta.date_start||"").localeCompare(o.meta.date_start||"")),console.log(`[TELEMETRY] Loaded ${a.value.length} sessions for user ${e}`),a.value}catch(s){return console.error("[TELEMETRY] Error loading sessions:",s),f.value=s.message,[]}finally{n.value=!1}}async function Q(r,e){const s=e||m.value?.uid;if(!s)return null;try{const t=Y(A,`users/${s}/sessions/${r}`),o=await x(t);if(!o.exists()||(o.data().rawChunkCount||0)===0)return null;const d=S(A,`users/${s}/sessions/${r}/rawChunks`),l=L(d,k("idx","asc")),b=await E(l),c=[];b.forEach(y=>{const _=y.data();c.push({idx:_.idx,chunk:_.chunk})}),c.sort((y,_)=>y.idx-_.idx);const u=c.map(y=>y.chunk).join("");return JSON.parse(u)}catch(t){return console.error("[TELEMETRY] Error fetching full session:",t),null}}const v=g(()=>a.value.length===0?null:a.value[0]),w=g(()=>v.value?.meta.car||null),M=g(()=>v.value?.meta.track||null),D=g(()=>{const r=["Flood","Wet","Damp","Greasy","Green","Fast","Optimum"],e={};for(const s of a.value){const t=(s.meta.track||"unknown").toLowerCase(),o=s.summary;if(!e[t]){const b={};r.forEach(c=>{b[c]={bestQualy:null,bestQualyTemp:null,bestRace:null,bestRaceTemp:null,bestAvgRace:null,bestAvgRaceTemp:null}}),e[t]={track:s.meta.track,sessions:0,lastSession:s.meta.date_start,bestQualy:null,bestQualyConditions:null,bestRace:null,bestRaceConditions:null,bestAvgRace:null,bestAvgRaceConditions:null,bestByGrip:b}}e[t].sessions++,s.meta.date_start>e[t].lastSession&&(e[t].lastSession=s.meta.date_start);const i=o?.best_by_grip;if(i)for(const b of r){const c=i[b];if(!c)continue;const u=e[t].bestByGrip[b];c.bestQualy&&(!u.bestQualy||c.bestQualy<u.bestQualy)&&(u.bestQualy=c.bestQualy,u.bestQualyTemp=c.bestQualyTemp),c.bestRace&&(!u.bestRace||c.bestRace<u.bestRace)&&(u.bestRace=c.bestRace,u.bestRaceTemp=c.bestRaceTemp),c.bestAvgRace&&(!u.bestAvgRace||c.bestAvgRace<u.bestAvgRace)&&(u.bestAvgRace=c.bestAvgRace,u.bestAvgRaceTemp=c.bestAvgRaceTemp)}const p=o?.best_qualy_ms;p?(!e[t].bestQualy||p<e[t].bestQualy)&&(e[t].bestQualy=p,e[t].bestQualyConditions=o.best_qualy_conditions||null):s.meta.session_type===R.QUALIFY&&o?.bestLap&&(!e[t].bestQualy||o.bestLap<e[t].bestQualy)&&(e[t].bestQualy=o.bestLap,e[t].bestQualyConditions=null);const d=o?.best_race_ms;d?(!e[t].bestRace||d<e[t].bestRace)&&(e[t].bestRace=d,e[t].bestRaceConditions=o.best_race_conditions||null):s.meta.session_type===R.RACE&&o?.bestLap&&(!e[t].bestRace||o.bestLap<e[t].bestRace)&&(e[t].bestRace=o.bestLap,e[t].bestRaceConditions=null);const l=o?.best_avg_race_ms;l&&(!e[t].bestAvgRace||l<e[t].bestAvgRace)&&(e[t].bestAvgRace=l,e[t].bestAvgRaceConditions=o.best_avg_race_conditions||null)}return Object.values(e).sort((s,t)=>(t.lastSession||"").localeCompare(s.lastSession||""))});function I(r){return a.value.filter(e=>(e.meta.track||"").toLowerCase()===r.toLowerCase())}function $(r){return a.value.find(e=>e.sessionId===r)}function T(r=7){const e=new Date,s=["Dom","Lun","Mar","Mer","Gio","Ven","Sab"],t=[];for(let o=r-1;o>=0;o--){const i=new Date(e.getTime()-o*24*60*60*1e3),p=i.toISOString().split("T")[0],d=a.value.filter(l=>l.meta.date_start?.startsWith(p));t.push({day:s[i.getDay()],practice:d.filter(l=>l.meta.session_type===R.PRACTICE).length,qualify:d.filter(l=>l.meta.session_type===R.QUALIFY).length,race:d.filter(l=>l.meta.session_type===R.RACE).length})}return t}const G=g(()=>{const r=T(7);return{practice:{minutes:r.reduce((e,s)=>e+s.practice*15,0),sessions:r.reduce((e,s)=>e+s.practice,0)},qualify:{minutes:r.reduce((e,s)=>e+s.qualify*10,0),sessions:r.reduce((e,s)=>e+s.qualify,0)},race:{minutes:r.reduce((e,s)=>e+s.race*25,0),sessions:r.reduce((e,s)=>e+s.race,0)}}});return{sessions:a,isLoading:n,error:f,loadSessions:h,fetchSessionFull:Q,getSessionsForTrack:I,getSession:$,getActivityData:T,lastSession:v,lastUsedCar:w,lastUsedTrack:M,trackStats:D,activityTotals:G}}export{R as S,W as _,J as a,Z as b,ee as c,X as d,K as e,V as f,z as g,te as u};
