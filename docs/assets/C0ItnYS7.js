import{b as U,C as B,D as F,a6 as N,_ as x,r as _,a as Y,m as C,Q as q,R as A,X as P,U as E,a3 as S,ac as k,V as T,ad as j,ae as H}from"./I2aJUgan.js";const V={class:"page-container"},z=U({__name:"PageContainer",setup(s){return(a,b)=>(F(),B("div",V,[N(a.$slots,"default",{},void 0)]))}}),X=Object.assign(x(z,[["__scopeId","data-v-71e40101"]]),{__name:"LayoutPageContainer"}),y={RACE:0,QUALIFY:1,PRACTICE:2};function J(s){switch(s){case 0:return"race";case 1:return"qualify";default:return"practice"}}function K(s){if(!s||s<=0)return"--:--.---";const a=Math.round(s),b=Math.floor(a/6e4),R=Math.floor(a%6e4/1e3),h=a%1e3;return`${b}:${R.toString().padStart(2,"0")}.${h.toString().padStart(3,"0")}`}function Z(s){return s?s.split("_").map((a,b)=>a.match(/^gt\d$/i)||a.length<=2?a.toUpperCase():a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()).join(" "):"Unknown"}function ee(s){return s?s.split("_").map(a=>a.charAt(0).toUpperCase()+a.slice(1).toLowerCase()).join(" "):"Unknown"}function te(s){if(!s)return"-";const a=new Date(s);return`${a.getDate()} ${["Gen","Feb","Mar","Apr","Mag","Giu","Lug","Ago","Set","Ott","Nov","Dic"][a.getMonth()]} ${a.getFullYear()}`}function se(s){if(!s)return"-";const a=new Date(s);return`${a.getDate()} ${["GENNAIO","FEBBRAIO","MARZO","APRILE","MAGGIO","GIUGNO","LUGLIO","AGOSTO","SETTEMBRE","OTTOBRE","NOVEMBRE","DICEMBRE"][a.getMonth()]} ${a.getFullYear()}`}function ae(s){if(!s)return"-";const a=new Date(s);return`${a.getHours().toString().padStart(2,"0")}:${a.getMinutes().toString().padStart(2,"0")}`}function ne(){const s=_([]),a=_(!1),b=_(null),{currentUser:R}=Y();async function h(u){const t=u||R.value?.uid;if(!t)return console.warn("[TELEMETRY] No user ID provided"),[];a.value=!0,b.value=null;try{const o=E(A,`users/${t}/sessions`);let e;try{const n=S(o,k("uploadedAt","desc"));e=await T(n)}catch{console.warn("[TELEMETRY] orderBy failed, fetching without order"),e=await T(o)}return s.value=e.docs.map(n=>{const c=n.data();return{sessionId:n.id,fileHash:c.fileHash||null,fileName:c.fileName||null,uploadedAt:c.uploadedAt||null,meta:c.meta||{},summary:c.summary||{},rawChunkCount:c.rawChunkCount||0,rawSizeBytes:c.rawSizeBytes||0}}),s.value.sort((n,c)=>(c.meta.date_start||"").localeCompare(n.meta.date_start||"")),console.log(`[TELEMETRY] Loaded ${s.value.length} sessions for user ${t}`),s.value}catch(o){return console.error("[TELEMETRY] Error loading sessions:",o),b.value=o.message,[]}finally{a.value=!1}}async function L(u,t){const o=t||R.value?.uid;if(!o)return null;try{const e=q(A,`users/${o}/sessions/${u}`),n=await P(e);if(!n.exists()||(n.data().rawChunkCount||0)===0)return null;const m=E(A,`users/${o}/sessions/${u}/rawChunks`),l=S(m,k("idx","asc")),f=await T(l),r=[];f.forEach(g=>{const p=g.data();r.push({idx:p.idx,chunk:p.chunk})}),r.sort((g,p)=>g.idx-p.idx);const i=r.map(g=>g.chunk).join("");return JSON.parse(i)}catch(e){return console.error("[TELEMETRY] Error fetching full session:",e),null}}const v=C(()=>s.value.length===0?null:s.value[0]),w=C(()=>v.value?.meta.car||null),D=C(()=>v.value?.meta.track||null),Q=C(()=>{const u=["Flood","Wet","Damp","Greasy","Green","Fast","Optimum"],t={};for(const o of s.value){const e=(o.meta.track||"unknown").toLowerCase(),n=o.summary;if(!t[e]){const f={};u.forEach(r=>{f[r]={bestQualy:null,bestQualyTemp:null,bestRace:null,bestRaceTemp:null,bestAvgRace:null,bestAvgRaceTemp:null}}),t[e]={track:o.meta.track,sessions:0,lastSession:o.meta.date_start,bestQualy:null,bestQualyConditions:null,bestRace:null,bestRaceConditions:null,bestAvgRace:null,bestAvgRaceConditions:null,bestByGrip:f}}t[e].sessions++,o.meta.date_start>t[e].lastSession&&(t[e].lastSession=o.meta.date_start);const c=n?.best_by_grip;if(c)for(const f of u){const r=c[f];if(!r)continue;const i=t[e].bestByGrip[f];i&&(r.bestQualy&&(!i.bestQualy||r.bestQualy<i.bestQualy)&&(i.bestQualy=r.bestQualy,i.bestQualyTemp=r.bestQualyTemp),r.bestRace&&(!i.bestRace||r.bestRace<i.bestRace)&&(i.bestRace=r.bestRace,i.bestRaceTemp=r.bestRaceTemp),r.bestAvgRace&&(!i.bestAvgRace||r.bestAvgRace<i.bestAvgRace)&&(i.bestAvgRace=r.bestAvgRace,i.bestAvgRaceTemp=r.bestAvgRaceTemp))}const d=n?.best_qualy_ms;d?(!t[e].bestQualy||d<t[e].bestQualy)&&(t[e].bestQualy=d,t[e].bestQualyConditions=n.best_qualy_conditions||null):o.meta.session_type===y.QUALIFY&&n?.bestLap&&(!t[e].bestQualy||n.bestLap<t[e].bestQualy)&&(t[e].bestQualy=n.bestLap,t[e].bestQualyConditions=null);const m=n?.best_race_ms;m?(!t[e].bestRace||m<t[e].bestRace)&&(t[e].bestRace=m,t[e].bestRaceConditions=n.best_race_conditions||null):o.meta.session_type===y.RACE&&n?.bestLap&&(!t[e].bestRace||n.bestLap<t[e].bestRace)&&(t[e].bestRace=n.bestLap,t[e].bestRaceConditions=null);const l=n?.best_avg_race_ms;l&&(!t[e].bestAvgRace||l<t[e].bestAvgRace)&&(t[e].bestAvgRace=l,t[e].bestAvgRaceConditions=n.best_avg_race_conditions||null)}return Object.values(t).sort((o,e)=>(e.lastSession||"").localeCompare(o.lastSession||""))});function I(u){return s.value.filter(t=>(t.meta.track||"").toLowerCase()===u.toLowerCase())}function O(u){return s.value.find(t=>t.sessionId===u)}function $(u=7){const t=new Date,o=["Dom","Lun","Mar","Mer","Gio","Ven","Sab"],e=[];for(let n=u-1;n>=0;n--){const c=new Date(t.getTime()-n*24*60*60*1e3),d=c.toISOString().split("T")[0]||"",m=s.value.filter(i=>i.meta.date_start?.startsWith(d));let l=0,f=0,r=0;for(const i of m){const g=i.summary?.totalTime||0,p=Math.round(g/6e4);switch(i.meta.session_type){case y.PRACTICE:l+=p;break;case y.QUALIFY:f+=p;break;case y.RACE:r+=p;break}}e.push({day:o[c.getDay()]||"N/A",practice:l,qualify:f,race:r})}return e}const G=C(()=>{const u=new Date,t=new Date(u.getTime()-10080*60*1e3);let o=0,e=0,n=0,c=0,d=0,m=0;for(const l of s.value){if(new Date(l.meta.date_start)<t)continue;const r=l.summary?.totalTime||0,i=Math.round(r/6e4);switch(l.meta.session_type){case y.PRACTICE:o+=i,e++;break;case y.QUALIFY:n+=i,c++;break;case y.RACE:d+=i,m++;break}}return{practice:{minutes:o,sessions:e},qualify:{minutes:n,sessions:c},race:{minutes:d,sessions:m}}});return{sessions:s,isLoading:a,error:b,loadSessions:h,fetchSessionFull:L,getSessionsForTrack:I,getSession:O,getActivityData:$,lastSession:v,lastUsedCar:w,lastUsedTrack:D,trackStats:Q,activityTotals:G}}const M=Symbol("pilotContext");function oe(s){const a=_(s);return H(M,a),a}function re(){return j(M,_(null))}export{y as S,X as _,ne as a,K as b,Z as c,ae as d,se as e,ee as f,J as g,te as h,oe as p,re as u};
