import{_ as R}from"./B6b2hjfc.js";import{_ as M}from"./DyEAc5C3.js";import{b as O,a as V,r as v,t as C,o as z,L as K,F as u,J as E,G as s,E as d,P as T,I as W,H as r,Q as L,R as N,a0 as Y,K as j,W as D,T as g,X as x,a1 as q,Y as y,S,_ as H}from"./CKuEThbc.js";const J={class:"cleanup-container"},Q={class:"stats-row"},X={class:"stat-box"},Z={class:"stat-value"},ss={class:"stat-box stat-box--warning"},es={class:"stat-value"},ts={class:"stat-box stat-box--danger"},os={class:"stat-value"},as={class:"stat-box stat-box--success"},ns={class:"stat-value"},ls={class:"actions-row"},cs=["disabled"],is=["disabled"],rs={key:0,class:"error-box"},us={key:1,class:"loading-box"},ds={key:2,class:"groups-list"},ps={class:"group-header"},_s={class:"group-key"},fs=["onClick"],vs={class:"group-sessions"},gs={class:"session-format"},hs={class:"session-id"},ms={class:"session-track"},bs={class:"session-date"},ks={key:3,class:"success-box"},Cs=O({__name:"dev-cleanup",setup(ys){const{currentUser:f}=V(),p=v(!1),I=v([]),_=v(new Map),$=v(0),h=v(null);function m(o){return/^\d{13}_/.test(o)}function F(o){const t=(o.meta?.track||"unknown").toLowerCase().replace(/\s+/g,"_");return`${(o.meta?.date_start||"").split(":").slice(0,2).join(":")}_${t}`}async function b(){if(f.value){p.value=!0,h.value=null;try{const o=f.value.uid,t=D(g,`users/${o}/sessions`),l=await x(q(t)),c=[];l.forEach(e=>{c.push({sessionId:e.id,...e.data()})}),I.value=c;const a=new Map;for(const e of c){const i=F(e);a.has(i)||a.set(i,[]),a.get(i).push(e)}const n=new Map;for(const[e,i]of a)i.length>1&&n.set(e,i);_.value=n,console.log(`[CLEANUP] Found ${c.length} sessions, ${n.size} duplicate groups`)}catch(o){h.value=o.message,console.error("[CLEANUP] Error:",o)}finally{p.value=!1}}}async function P(o){if(!f.value)return;const t=f.value.uid,l=_.value.get(o);if(!l)return;const c=l.filter(a=>m(a.sessionId));for(const a of c)try{const n=D(g,`users/${t}/sessions/${a.sessionId}/rawChunks`),e=await x(n);for(const k of e.docs)await y(k.ref);const i=S(g,`users/${t}/sessions/${a.sessionId}`);await y(i),$.value++,console.log(`[CLEANUP] Deleted: ${a.sessionId}`)}catch(n){console.error(`[CLEANUP] Error deleting ${a.sessionId}:`,n.message)}await b()}async function U(){if(!f.value)return;p.value=!0;const o=f.value.uid;for(const[t,l]of _.value){if(l.length<=1)continue;const c=[...l].sort((n,e)=>{const i=n.uploadedAt?.toMillis?.()||n.uploadedAt?.seconds*1e3||0;return(e.uploadedAt?.toMillis?.()||e.uploadedAt?.seconds*1e3||0)-i}),a=c.slice(1);console.log(`[CLEANUP] Group ${t}: keeping ${c[0].sessionId}, deleting ${a.length} older duplicates`);for(const n of a)try{const e=D(g,`users/${o}/sessions/${n.sessionId}/rawChunks`),i=await x(e);for(const G of i.docs)await y(G.ref);const k=S(g,`users/${o}/sessions/${n.sessionId}`);await y(k),$.value++,console.log(`[CLEANUP] üóëÔ∏è Deleted older duplicate: ${n.sessionId}`)}catch(e){console.error(`[CLEANUP] Error deleting ${n.sessionId}:`,e.message)}}p.value=!1,await b()}const B=C(()=>I.value.length),A=C(()=>_.value.size);C(()=>{let o=0;for(const[t,l]of _.value)o+=l.filter(c=>m(c.sessionId)).length;return o});const w=C(()=>{let o=0;for(const[t,l]of _.value)l.length>1&&(o+=l.length-1);return o});return z(()=>{b()}),(o,t)=>{const l=R,c=M;return u(),K(c,null,{default:E(()=>[t[5]||(t[5]=s("h1",{class:"page-title"},"DEV Cleanup - Duplicate Sessions",-1)),s("div",J,[s("div",Q,[s("div",X,[s("span",Z,r(B.value),1),t[0]||(t[0]=s("span",{class:"stat-label"},"Total Sessions",-1))]),s("div",ss,[s("span",es,r(A.value),1),t[1]||(t[1]=s("span",{class:"stat-label"},"Duplicate Groups",-1))]),s("div",ts,[s("span",os,r(w.value),1),t[2]||(t[2]=s("span",{class:"stat-label"},"Duplicates to Delete",-1))]),s("div",as,[s("span",ns,r($.value),1),t[3]||(t[3]=s("span",{class:"stat-label"},"Deleted",-1))])]),s("div",ls,[s("button",{onClick:b,disabled:p.value,class:"btn btn--secondary"}," üîÑ Refresh ",8,cs),s("button",{onClick:U,disabled:p.value||w.value===0,class:"btn btn--danger"}," üóëÔ∏è Delete All Duplicates ("+r(w.value)+") ",9,is)]),h.value?(u(),d("div",rs,r(h.value),1)):T("",!0),p.value?(u(),d("div",us," Loading... ")):A.value>0?(u(),d("div",ds,[(u(!0),d(L,null,N(_.value,([a,n])=>(u(),d("div",{key:a,class:"group-card"},[s("div",ps,[s("span",_s,r(a),1),s("button",{onClick:e=>P(a),class:"btn btn--small btn--danger"}," Delete Old Format ",8,fs)]),s("div",vs,[(u(!0),d(L,null,N(n,e=>(u(),d("div",{key:e.sessionId,class:Y(["session-item",{"session-item--old":m(e.sessionId)}])},[s("span",gs,r(m(e.sessionId)?"‚ö†Ô∏è OLD":"‚úÖ NEW"),1),s("span",hs,r(e.sessionId),1),s("span",ms,r(e.meta?.track),1),s("span",bs,r(e.meta?.date_start?.split("T")[0]),1)],2))),128))])]))),128))])):(u(),d("div",ks," ‚úÖ No duplicates found! Your sessions are clean. ")),W(l,{to:"/panoramica",class:"back-link"},{default:E(()=>[...t[4]||(t[4]=[j(" ‚Üê Back to Dashboard ",-1)])]),_:1})])]),_:1})}}}),xs=H(Cs,[["__scopeId","data-v-c9bd059d"]]);export{xs as default};
