import{_ as V}from"./IrcXy1tG.js";import{_ as E}from"./DcZKsx5T.js";import{b as P,a as W,a2 as z,r as k,t as D,o as M,L as q,F as a,J as x,G as s,E as l,P as h,I as H,H as o,Q as y,R as m,a0 as $,K as I,W as J,T as L,X as K,a1 as Q,S as X,Y,_ as Z}from"./DRE7tGjo.js";const ss={class:"audit-container"},es={class:"stats-row"},ts={class:"stat-box"},as={class:"stat-value"},ls={class:"stat-box"},ns={class:"stat-value"},os={class:"stat-box stat-box--warning"},cs={class:"stat-value"},is={class:"stat-box stat-box--info"},rs={class:"stat-value"},us={class:"actions-row"},ds=["disabled"],_s=["disabled"],vs=["disabled"],ps={key:0,class:"progress-log"},bs={key:1,class:"error-box"},ks={key:2,class:"loading-box"},gs={key:3,class:"section"},hs={key:0,class:"trackbests-list"},ys={class:"trackbest-header"},ms={class:"trackbest-name"},fs={key:0,class:"legacy-badge"},Bs={class:"trackbest-stats"},Ds={key:0},ws={key:1},Ts={class:"trackbest-grips"},Os={class:"trackbest-actions"},xs=["onClick"],$s=["onClick"],Ls={key:1,class:"empty-box"},Cs={key:4,class:"section"},Fs={class:"legacy-sessions-list"},As={class:"session-id"},Ss={class:"session-track"},Ns={class:"session-date"},Rs=P({__name:"dev-data-audit",setup(Gs){const{currentUser:u}=W(),{sessions:C,trackStats:F,loadSessions:A,forceRecalculateTrackBests:S}=z(),c=k(!1),i=k({}),v=k([]),r=k([]),p=k(null);async function f(){if(u.value){c.value=!0,p.value=null,i.value={};try{const t=u.value.uid,e=J(L,`users/${t}/trackBests`);(await K(Q(e))).forEach(b=>{i.value[b.id]={id:b.id,...b.data()}}),console.log(`[AUDIT] Loaded ${Object.keys(i.value).length} trackBests documents`)}catch(t){p.value=t.message}finally{c.value=!1}}}function N(){v.value=C.value.filter(t=>{const e=t.summary?.best_by_grip;return e&&Object.keys(e).includes("Opt")}),console.log(`[AUDIT] Found ${v.value.length} sessions with legacy 'Opt' grip`)}async function w(t){if(u.value)try{const e=u.value.uid,g=X(L,`users/${e}/trackBests/${t}`);await Y(g),delete i.value[t],r.value.push(`Deleted: ${t}`),console.log(`[AUDIT] Deleted trackBests: ${t}`)}catch(e){p.value=`Failed to delete ${t}: ${e.message}`}}async function T(t){if(u.value){r.value.push(`Recalculating: ${t}...`);try{await S(t),r.value.push(`‚úÖ Done: ${t}`)}catch(e){r.value.push(`‚ùå Failed: ${t} - ${e.message}`)}await f()}}async function R(){if(!u.value)return;c.value=!0,r.value=[];const t=Object.keys(i.value);for(const e of t)await T(e);c.value=!1}async function G(){if(!u.value||!confirm("Delete ALL trackBests? They will be recalculated on next page load."))return;c.value=!0,r.value=[];const t=Object.keys(i.value);for(const e of t)await w(e);c.value=!1}function B(t){return!!(t.Opt||t.bests?.Opt||!t.bests&&(t.Optimum||t.Fast||t.Green))}const O=D(()=>Object.keys(i.value).length),j=D(()=>Object.values(i.value).filter(B).length),U=D(()=>F.value.length);return M(async()=>{await A(),await f(),N()}),(t,e)=>{const g=V,b=E;return a(),q(b,null,{default:x(()=>[e[8]||(e[8]=s("h1",{class:"page-title"},"DEV Data Audit - TrackBests Manager",-1)),s("div",ss,[s("div",es,[s("div",ts,[s("span",as,o(U.value),1),e[0]||(e[0]=s("span",{class:"stat-label"},"Tracks with Sessions",-1))]),s("div",ls,[s("span",ns,o(O.value),1),e[1]||(e[1]=s("span",{class:"stat-label"},"TrackBests Docs",-1))]),s("div",os,[s("span",cs,o(j.value),1),e[2]||(e[2]=s("span",{class:"stat-label"},"Legacy Format",-1))]),s("div",is,[s("span",rs,o(v.value.length),1),e[3]||(e[3]=s("span",{class:"stat-label"},"Sessions with 'Opt'",-1))])]),s("div",us,[s("button",{onClick:f,disabled:c.value,class:"btn btn--secondary"}," üîÑ Refresh ",8,ds),s("button",{onClick:R,disabled:c.value,class:"btn btn--primary"}," ‚ö° Recalculate All ",8,_s),s("button",{onClick:G,disabled:c.value,class:"btn btn--danger"}," üóëÔ∏è Delete All TrackBests ",8,vs)]),r.value.length>0?(a(),l("div",ps,[(a(!0),l(y,null,m(r.value,(n,_)=>(a(),l("div",{key:_,class:"progress-item"},o(n),1))),128))])):h("",!0),p.value?(a(),l("div",bs,o(p.value),1)):h("",!0),c.value?(a(),l("div",ks," Loading... ")):(a(),l("div",gs,[e[4]||(e[4]=s("h2",{class:"section-title"},"TrackBests Documents",-1)),O.value>0?(a(),l("div",hs,[(a(!0),l(y,null,m(i.value,(n,_)=>(a(),l("div",{key:_,class:$(["trackbest-card",{"trackbest-card--legacy":B(n)}])},[s("div",ys,[s("span",ms,o(_),1),B(n)?(a(),l("span",fs,"‚ö†Ô∏è Legacy")):h("",!0)]),s("div",Bs,[s("span",null,"Updated: "+o(n.lastUpdated?.split("T")[0]||"N/A"),1),n.bests?(a(),l("span",Ds,"Format: ‚úÖ New (bests wrapper)")):(a(),l("span",ws,"Format: ‚ö†Ô∏è Old (root level)"))]),s("div",Ts,[(a(),l(y,null,m(["Optimum","Fast","Green","Greasy","Damp","Wet","Opt"],d=>s("span",{key:d,class:$(["grip-badge",{"grip-badge--has-data":n.bests?.[d]||n[d],"grip-badge--legacy":d==="Opt"}])},o(d),3)),64))]),s("div",Os,[s("button",{onClick:d=>T(String(_)),class:"btn btn--small btn--primary"}," ‚ö° Recalc ",8,xs),s("button",{onClick:d=>w(String(_)),class:"btn btn--small btn--danger"}," üóëÔ∏è Delete ",8,$s)])],2))),128))])):(a(),l("div",Ls," No trackBests documents found. "))])),v.value.length>0?(a(),l("div",Cs,[e[5]||(e[5]=s("h2",{class:"section-title"},"Sessions with Legacy 'Opt' Grip",-1)),e[6]||(e[6]=s("p",{class:"section-hint"},"These sessions have 'Opt' in best_by_grip. New sessions will normalize to 'Optimum'.",-1)),s("div",Fs,[(a(!0),l(y,null,m(v.value,n=>(a(),l("div",{key:n.sessionId,class:"legacy-session-item"},[s("span",As,o(n.sessionId),1),s("span",Ss,o(n.meta?.track),1),s("span",Ns,o(n.meta?.date_start?.split("T")[0]),1)]))),128))])])):h("",!0),H(g,{to:"/panoramica",class:"back-link"},{default:x(()=>[...e[7]||(e[7]=[I(" ‚Üê Back to Dashboard ",-1)])]),_:1})])]),_:1})}}}),Es=Z(Rs,[["__scopeId","data-v-ef36c75c"]]);export{Es as default};
