import{_ as P}from"./C8zJQDWB.js";import{_ as B}from"./xOCTEXod.js";import{b as R,a as U,r as f,t as k,o as V,L as z,F as r,J as I,G as s,E as d,P as K,I as M,H as l,Q as D,R as L,a0 as T,K as W,W as $,T as y,X as E,a1 as Y,Y as N,S as j,_ as q}from"./DNIypS_s.js";const H={class:"cleanup-container"},J={class:"stats-row"},Q={class:"stat-box"},X={class:"stat-value"},Z={class:"stat-box stat-box--warning"},ss={class:"stat-value"},ts={class:"stat-box stat-box--danger"},es={class:"stat-value"},os={class:"stat-box stat-box--success"},as={class:"stat-value"},ns={class:"actions-row"},ls=["disabled"],cs=["disabled"],is={key:0,class:"error-box"},rs={key:1,class:"loading-box"},us={key:2,class:"groups-list"},ds={class:"group-header"},_s={class:"group-key"},ps=["onClick"],vs={class:"group-sessions"},fs={class:"session-format"},ms={class:"session-id"},gs={class:"session-track"},hs={class:"session-date"},bs={key:3,class:"success-box"},ks=R({__name:"dev-cleanup",setup(ys){const{currentUser:v}=U(),_=f(!1),C=f([]),p=f(new Map),x=f(0),m=f(null);function g(e){return/^\d{13}_/.test(e)}function S(e){const t=(e.meta?.track||"unknown").toLowerCase().replace(/\s+/g,"_");return`${(e.meta?.date_start||"").split(":").slice(0,2).join(":")}_${t}`}async function h(){if(v.value){_.value=!0,m.value=null;try{const e=v.value.uid,t=$(y,`users/${e}/sessions`),c=await E(Y(t)),n=[];c.forEach(o=>{n.push({sessionId:o.id,...o.data()})}),C.value=n;const a=new Map;for(const o of n){const u=S(o);a.has(u)||a.set(u,[]),a.get(u).push(o)}const i=new Map;for(const[o,u]of a)u.length>1&&i.set(o,u);p.value=i,console.log(`[CLEANUP] Found ${n.length} sessions, ${i.size} duplicate groups`)}catch(e){m.value=e.message,console.error("[CLEANUP] Error:",e)}finally{_.value=!1}}}async function w(e){if(!v.value)return;const t=v.value.uid,c=p.value.get(e);if(!c)return;const n=c.filter(a=>g(a.sessionId));for(const a of n)try{const i=$(y,`users/${t}/sessions/${a.sessionId}/rawChunks`),o=await E(i);for(const G of o.docs)await N(G.ref);const u=j(y,`users/${t}/sessions/${a.sessionId}`);await N(u),x.value++,console.log(`[CLEANUP] Deleted: ${a.sessionId}`)}catch(i){console.error(`[CLEANUP] Error deleting ${a.sessionId}:`,i.message)}await h()}async function A(){if(v.value){_.value=!0;for(const[e,t]of p.value)await w(e);_.value=!1}}const O=k(()=>C.value.length),F=k(()=>p.value.size),b=k(()=>{let e=0;for(const[t,c]of p.value)e+=c.filter(n=>g(n.sessionId)).length;return e});return V(()=>{h()}),(e,t)=>{const c=P,n=B;return r(),z(n,null,{default:I(()=>[t[5]||(t[5]=s("h1",{class:"page-title"},"DEV Cleanup - Duplicate Sessions",-1)),s("div",H,[s("div",J,[s("div",Q,[s("span",X,l(O.value),1),t[0]||(t[0]=s("span",{class:"stat-label"},"Total Sessions",-1))]),s("div",Z,[s("span",ss,l(F.value),1),t[1]||(t[1]=s("span",{class:"stat-label"},"Duplicate Groups",-1))]),s("div",ts,[s("span",es,l(b.value),1),t[2]||(t[2]=s("span",{class:"stat-label"},"Old Format (to delete)",-1))]),s("div",os,[s("span",as,l(x.value),1),t[3]||(t[3]=s("span",{class:"stat-label"},"Deleted",-1))])]),s("div",ns,[s("button",{onClick:h,disabled:_.value,class:"btn btn--secondary"}," üîÑ Refresh ",8,ls),s("button",{onClick:A,disabled:_.value||b.value===0,class:"btn btn--danger"}," üóëÔ∏è Delete All Old Format ("+l(b.value)+") ",9,cs)]),m.value?(r(),d("div",is,l(m.value),1)):K("",!0),_.value?(r(),d("div",rs," Loading... ")):F.value>0?(r(),d("div",us,[(r(!0),d(D,null,L(p.value,([a,i])=>(r(),d("div",{key:a,class:"group-card"},[s("div",ds,[s("span",_s,l(a),1),s("button",{onClick:o=>w(a),class:"btn btn--small btn--danger"}," Delete Old Format ",8,ps)]),s("div",vs,[(r(!0),d(D,null,L(i,o=>(r(),d("div",{key:o.sessionId,class:T(["session-item",{"session-item--old":g(o.sessionId)}])},[s("span",fs,l(g(o.sessionId)?"‚ö†Ô∏è OLD":"‚úÖ NEW"),1),s("span",ms,l(o.sessionId),1),s("span",gs,l(o.meta?.track),1),s("span",hs,l(o.meta?.date_start?.split("T")[0]),1)],2))),128))])]))),128))])):(r(),d("div",bs," ‚úÖ No duplicates found! Your sessions are clean. ")),M(c,{to:"/panoramica",class:"back-link"},{default:I(()=>[...t[4]||(t[4]=[W(" ‚Üê Back to Dashboard ",-1)])]),_:1})])]),_:1})}}}),Fs=q(ks,[["__scopeId","data-v-6aac95cc"]]);export{Fs as default};
